# Vercel 图片下载优化指南

## 🔍 问题分析

根据日志分析，图片生成流程在Vercel环境中卡在了图片下载阶段：
- 本地测试：图片下载正常（973ms，87KB）
- Vercel环境：下载超时，卡在"下载尝试 1/3，超时时间: 8000ms"

## 🚀 优化策略

### 1. 超时时间优化
- **之前**: Vercel环境8秒超时，本地15秒
- **现在**: Vercel环境5秒基础超时，最大15秒，本地10秒
- **策略**: 减少单次超时时间，但增加重试次数

### 2. 重试机制优化
- **重试次数**: Vercel环境从3次增加到5次
- **重试延迟**: Vercel环境使用更短的延迟（500ms递增）
- **超时递增**: 每次重试增加2秒，最大15秒

### 3. 下载策略优化
- **前两次尝试**: 使用标准图片下载配置
- **后续尝试**: 使用简化的HTTP请求配置
- **备用方法**: 不同的User-Agent和Accept头

### 4. 详细日志添加
- 下载开始和结束时间
- 每次重试的详细信息
- 响应状态和头部信息
- 错误类型和堆栈跟踪
- 数据读取耗时统计

## 📊 优化后的配置

```typescript
// Vercel环境
maxRetries: 5
baseTimeout: 5000ms
maxTimeout: 15000ms
retryDelay: 500ms * (attempt + 1)

// 本地环境
maxRetries: 3
baseTimeout: 10000ms
maxTimeout: 15000ms
retryDelay: 1000ms * (attempt + 1)
```

## 🔄 重试时间表

| 尝试 | 超时时间 | 延迟时间 | 总时间 |
|------|----------|----------|--------|
| 1    | 5000ms   | 0ms      | 5s     |
| 2    | 7000ms   | 500ms    | 12.5s  |
| 3    | 9000ms   | 1000ms   | 22.5s  |
| 4    | 11000ms  | 1500ms   | 35s    |
| 5    | 13000ms  | 2000ms   | 50s    |

## 📝 监控要点

在Vercel日志中关注以下信息：
- `📥 [图片下载] 开始下载图片` - 下载开始
- `📥 [下载尝试 X/5] fetch完成` - 每次尝试结果
- `✅ [下载成功] 大小: XXKB` - 成功下载
- `⚠️ [下载失败 X/5]` - 失败重试
- `❌ [图片下载] 所有重试尝试都失败了` - 最终失败

## 🎯 预期效果

1. **更快的失败检测**: 5秒超时比8秒更快发现问题
2. **更高的成功率**: 5次重试比3次有更多机会成功
3. **更好的诊断**: 详细日志帮助快速定位问题
4. **更灵活的策略**: 不同重试阶段使用不同配置

## 🔧 如果问题仍然存在

如果优化后问题仍然存在，可能需要考虑：
1. 使用CDN或代理服务
2. 预下载图片到本地存储
3. 使用不同的HTTP客户端库
4. 检查Vercel的网络限制
